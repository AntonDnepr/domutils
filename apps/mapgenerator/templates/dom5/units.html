{% extends "base.html" %}

{% block main_content %}
<div class="container mt-5">
  <div class="text-center">
    <h2 class="display-4 mb-4">Select units for nation {{name}}</h2>
  </div>
  <div class="row">
    <div class="mb-4">
        <p class="lead">Select units that will be used for indicated nation.</p>
        <p>For this step, you should select commanders and units. You can skip this if you do not want to add anything to starting troops of the nation;</p>
        <p>For map to generate correctly, you should have at least 1 commander to add additional units to;</p>
        <p>Some of the commanders and troops have the same name, so you should use unit_id to distinguish them;</p>
        <p>Use <a href="https://larzm42.github.io/dom5inspector/" target="_blank" rel="noopener noreferrer">Dom5 inspector</a> to find out unit_id;</p>
    </div>
  </div>
  <div class="row">
    <form id="selectedMods">
      <div class="mb-4">
        <p>Select mods if you need any:</p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="de" name="mods" id="DominionsEnhanced">
          <label class="form-check-label" for="DominionsEnhanced">
            DominionsEnhanced
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="debug" name="mods" id="DebugMod">
          <label class="form-check-label" for="DebugMod">
            DebugMod
          </label>
        </div>
      </div>
    </form>
    <div class="row">
      <div class="col-12">
        <button id="visibility" type="button" class="btn btn-secondary">
          Show/hide search fields
        </button>
      </div>
      <div class="col-6">
        <form>
            <div class="mb-3 parent-js">
              <label for="commanders" class="form-label">Commanders search</label>
              <input type="text" class="form-control" id="commanders" name="search_term" data-id="commanders"
                hx-trigger="keyup changed delay:500ms" hx-target="#commandersResults" placeholder="Search..."
                hx-include="#selectedMods" hx-get="/dom5/autocomplete/units/">
              <div id="commandersResults" data-type="commanders" class="mt-2 results-js">

              </div>
            </div>
        </form>
        <div class="col-12 mt-2">
          <h4>Selected commanders</h4>
        </div>
        <div class="col-12 mt-2" id="selectedCommandersResults">

        </div>
      </div>
      <div class="col-6">
        <form>
          <div class="mb-3 parent-js">
            <label for="units" class="form-label">Units search</label>
            <input type="text" class="form-control" id="units" name="search_term" data-id="units"
            hx-trigger="keyup changed delay:500ms" hx-target="#unitsResults" placeholder="Search..."
            hx-include="#selectedMods" hx-get="/dom5/autocomplete/units/">
            <div id="unitsResults" data-type="units" class="mt-2 results-js">

            </div>
          </div>
        </form>
        <div class="col-12 mt-2">
          <h4>Selected units</h4>
        </div>
        <div class="col-12 mt-2" id="selectedUnitsResults">

        </div>
      </div>
    </div>
  </div>
</div>

<div id="hiddenMagicEdit" class="invisible">
  <div class="row magic-inputs-js">
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">F</span>
        <input data-short="F" data-type="fire" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">A</span>
        <input data-short="A" data-type="air" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">W</span>
        <input data-short="W" data-type="water" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">E</span>
        <input data-short="E" data-type="earth" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">S</span>
        <input data-short="S" data-type="astral" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">D</span>
        <input data-short="D" data-type="death" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">N</span>
        <input data-short="N" data-type="nature" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">B</span>
        <input data-short="B" data-type="blood" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <div class="input-group mb-3">
        <span class="input-group-text">Priest</span>
        <input data-short="Priest" data-type="priest" type="number" min="0" max="10" class="form-control">
      </div>
    </div>
    <div class="col-3">
      <button class="btn btn-primary save-close-js">Save & close</button>
    </div>
  </div>
</div>

{% endblock main_content %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
  htmx.onLoad(function(content) {
    var selectableRows = content.querySelectorAll(".selectable-js");
    for (var i = 0; i < selectableRows.length; i++) {
        var selectable = selectableRows[i];
        selectable.onclick = function() {
          var parentDiv = this.closest('.parent-js');
          var targetList = parentDiv.querySelector(".results-js");
          if (targetList.dataset["type"] === "commanders"){
            var targetElement = document.getElementById("selectedCommandersResults");
            var newElement = document.createElement('div');
            var dataName = this.getAttribute('data-name');
            var dataID = this.getAttribute('data-id');
            newElement.innerHTML = `<div class="magic-container-js mb-1">
              (${dataID}) ${dataName}
              <button type="button" class="btn btn-secondary edit-magic-js">Edit Magic</button>
              <button type="button" class="btn btn-info duplicate-row-js">Duplicate</button>
              <button type="button" class="btn btn-danger delete-row-js">Delete</button>
              <span class="magic-info-js">Default magic</span>
            </div>
            `;
            newElement.classList.add('mb-2');
            targetElement.appendChild(newElement);
          } else {
            var targetElement = document.getElementById("selectedUnitsResults");
            var newElement = document.createElement('div');
            var dataName = this.getAttribute('data-name');
            var dataID = this.getAttribute('data-id');
            newElement.innerHTML = `(${dataID}) ${dataName} <input type='number' value='1' min='1'/> <button type="button" class="btn btn-danger delete-row-js">Delete</button`;
            newElement.classList.add('mb-2');
            targetElement.appendChild(newElement);
          }
        };
    }
  });
  document.addEventListener('click', function(event) {
    var target = event.target;
    if (target.classList.contains('delete-row-js')) {
      var finalTarget = target.parentNode;
      finalTarget.parentNode.removeChild(finalTarget);
    } else if (target.classList.contains('duplicate-row-js')) {
      // duplicate target element
      var finalTarget = target.parentNode;
      var newElement = finalTarget.cloneNode(true);
      finalTarget.parentNode.appendChild(newElement);
    } else if (target.classList.contains('edit-magic-js')) {
      if (target.classList.contains('disabled')) {
        return
      }
      target.classList.add('disabled');
      var parent = target.parentNode;
      // copy html content of element with id hiddenMagicEdit and append it to parent
      var hiddenMagicEdit = document.getElementById("hiddenMagicEdit");
      parent.innerHTML += hiddenMagicEdit.innerHTML;
      var inputs = parent.querySelectorAll("input");
      for (var i = 0; i < inputs.length; i++) {
        var input = inputs[i];
        var type = input.getAttribute('data-type');
        var value = parent.dataset[type];
        if (value) {
          input.value = value;
        }
      }
    } else if (target.id === "visibility") {
      // iterate over all elements with parent-js class
      var elements = document.querySelectorAll(".parent-js");
      for (var i = 0; i < elements.length; i++) {
        var element = elements[i];
        if (element.style.display === "none") {
          element.style.display = "block";
        } else {
          element.style.display = "none";
        }
      }
    } else if (target.classList.contains('save-close-js')) {
      var removeTarget = target.parentNode.parentNode;
      var parent = removeTarget.parentNode;
      // take all inputs from parent, take there data-type and read input values
      var inputs = parent.querySelectorAll(".magic-inputs-js input");
      var finalMagicString = "";
      for (var i = 0; i < inputs.length; i++) {
        var input = inputs[i];
        var type = input.getAttribute('data-type');
        var value = input.value;
        if (value) {
          parent.dataset[type] = value;
          var short = input.getAttribute('data-short');
          finalMagicString += `${short}${value}|`;
        }
      }
      if (finalMagicString.length !== "") {
        var magicString = parent.querySelector(".magic-info-js");
        magicString.innerHTML = finalMagicString;
      }
      parent.removeChild(removeTarget);
      var editButton = parent.querySelector(".edit-magic-js");
      editButton.classList.remove('disabled');
    }
  });
</script>
{% endblock extra_js %}